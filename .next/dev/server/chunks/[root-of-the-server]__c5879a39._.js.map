{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///Users/8teen/Downloads/Devlopment/GitHub%20Repository/medsecurree/lib/db.ts"],"sourcesContent":["import { neon } from \"@neondatabase/serverless\"\n\n// Create a singleton instance of the SQL client\nlet sqlInstance: ReturnType<typeof neon> | null = null\n\n/**\n * Gets or creates a Neon SQL client instance\n */\nexport function getSql() {\n  if (!sqlInstance) {\n    const databaseUrl = process.env.NEON_POSTGRES_URL || process.env.NEON_NEON_NEON_DATABASE_URL\n    if (!databaseUrl) {\n      throw new Error(\"Database URL is not configured\")\n    }\n    sqlInstance = neon(databaseUrl)\n  }\n  return sqlInstance\n}\n\n/**\n * Fetches current vital data for a patient\n */\nexport async function getLatestVitals(patientId: string) {\n  const sql = getSql()\n  const result = await sql`SELECT * FROM vitals WHERE patient_id = ${patientId} ORDER BY recorded_at DESC LIMIT 1`\n  return result[0] || null\n}\n\n/**\n * Fetches all recent vitals for a patient\n */\nexport async function getRecentVitals(patientId: string, minutes = 60) {\n  const sql = getSql()\n  const result = await sql`SELECT * FROM vitals \n     WHERE patient_id = ${patientId} \n     AND recorded_at > NOW() - INTERVAL '${minutes} minutes'\n     ORDER BY recorded_at ASC`\n  return result\n}\n\n/**\n * Stores vital data in the database\n */\nexport async function storeVitals(vitalData: {\n  patientId: string\n  ambulanceId: string\n  heartRate: number\n  spo2: number\n  systolicBp: number\n  diastolicBp: number\n  temperature: number\n  status: string\n  encryptedData?: string\n}) {\n  const sql = getSql()\n  const result = await sql`INSERT INTO vitals \n     (patient_id, ambulance_id, heart_rate, spo2, systolic_bp, diastolic_bp, temperature, status, encrypted_data)\n     VALUES (${vitalData.patientId}, ${vitalData.ambulanceId}, ${vitalData.heartRate}, ${vitalData.spo2}, ${vitalData.systolicBp}, ${vitalData.diastolicBp}, ${vitalData.temperature}, ${vitalData.status}, ${vitalData.encryptedData || null})\n     RETURNING *`\n  return result[0]\n}\n\n/**\n * Creates an alert for critical conditions\n */\nexport async function createAlert(alertData: {\n  patientId: string\n  alertType: string\n  alertLevel: string\n  message: string\n}) {\n  const sql = getSql()\n  const result = await sql`INSERT INTO alerts (patient_id, alert_type, alert_level, message)\n     VALUES (${alertData.patientId}, ${alertData.alertType}, ${alertData.alertLevel}, ${alertData.message})\n     RETURNING *`\n  return result[0]\n}\n\n/**\n * Fetches all active (unacknowledged) alerts\n */\nexport async function getActiveAlerts() {\n  const sql = getSql()\n  const result = await sql`SELECT * FROM alerts WHERE is_acknowledged = FALSE ORDER BY created_at DESC`\n  return result\n}\n\n/**\n * Fetches all alerts for a specific patient\n */\nexport async function getPatientAlerts(patientId: string) {\n  const sql = getSql()\n  const result = await sql`SELECT * FROM alerts WHERE patient_id = ${patientId} ORDER BY created_at DESC LIMIT 50`\n  return result\n}\n\n/**\n * Acknowledges an alert\n */\nexport async function acknowledgeAlert(alertId: number, acknowledgedBy: string) {\n  const sql = getSql()\n  const result = await sql`UPDATE alerts \n     SET is_acknowledged = TRUE, acknowledged_by = ${acknowledgedBy}, acknowledged_at = NOW()\n     WHERE id = ${alertId}\n     RETURNING *`\n  return result[0]\n}\n\n/**\n * Fetches patient information\n */\nexport async function getPatient(patientId: string) {\n  const sql = getSql()\n  const result = await sql`SELECT * FROM patients WHERE patient_id = ${patientId}`\n  return result[0] || null\n}\n\n/**\n * Gets all patients\n */\nexport async function getAllPatients() {\n  const sql = getSql()\n  const result = await sql`SELECT * FROM patients`\n  return result\n}\n\n/**\n * Fetches all latest vitals for all patients grouped by patient\n */\nexport async function getAllLatestVitals() {\n  const sql = getSql()\n  const result = await sql`\n    SELECT DISTINCT ON (patient_id) *\n    FROM vitals\n    ORDER BY patient_id, recorded_at DESC\n  `\n  return result\n}\n\n/**\n * Fetches all patients with their latest vitals\n */\nexport async function getAllPatientsWithVitals() {\n  const sql = getSql()\n  const result = await sql`\n    SELECT \n      p.patient_id,\n      p.name,\n      p.age,\n      p.medical_condition,\n      v.id as vital_id,\n      v.heart_rate,\n      v.spo2,\n      v.systolic_bp,\n      v.diastolic_bp,\n      v.temperature,\n      v.status,\n      v.recorded_at,\n      v.encrypted_data,\n      v.ambulance_id\n    FROM patients p\n    LEFT JOIN LATERAL (\n      SELECT * FROM vitals\n      WHERE patient_id = p.patient_id\n      ORDER BY recorded_at DESC\n      LIMIT 1\n    ) v ON true\n    ORDER BY p.patient_id\n  `\n  return result\n}\n"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;AAAA;;AAEA,gDAAgD;AAChD,IAAI,cAA8C;AAK3C,SAAS;IACd,IAAI,CAAC,aAAa;QAChB,MAAM,cAAc,QAAQ,GAAG,CAAC,iBAAiB,IAAI,QAAQ,GAAG,CAAC,2BAA2B;QAC5F,IAAI,CAAC,aAAa;YAChB,MAAM,IAAI,MAAM;QAClB;QACA,cAAc,IAAA,gKAAI,EAAC;IACrB;IACA,OAAO;AACT;AAKO,eAAe,gBAAgB,SAAiB;IACrD,MAAM,MAAM;IACZ,MAAM,SAAS,MAAM,GAAG,CAAC,wCAAwC,EAAE,UAAU,kCAAkC,CAAC;IAChH,OAAO,MAAM,CAAC,EAAE,IAAI;AACtB;AAKO,eAAe,gBAAgB,SAAiB,EAAE,UAAU,EAAE;IACnE,MAAM,MAAM;IACZ,MAAM,SAAS,MAAM,GAAG,CAAC;wBACH,EAAE,UAAU;yCACK,EAAE,QAAQ;6BACtB,CAAC;IAC5B,OAAO;AACT;AAKO,eAAe,YAAY,SAUjC;IACC,MAAM,MAAM;IACZ,MAAM,SAAS,MAAM,GAAG,CAAC;;aAEd,EAAE,UAAU,SAAS,CAAC,EAAE,EAAE,UAAU,WAAW,CAAC,EAAE,EAAE,UAAU,SAAS,CAAC,EAAE,EAAE,UAAU,IAAI,CAAC,EAAE,EAAE,UAAU,UAAU,CAAC,EAAE,EAAE,UAAU,WAAW,CAAC,EAAE,EAAE,UAAU,WAAW,CAAC,EAAE,EAAE,UAAU,MAAM,CAAC,EAAE,EAAE,UAAU,aAAa,IAAI,KAAK;gBAC9N,CAAC;IACf,OAAO,MAAM,CAAC,EAAE;AAClB;AAKO,eAAe,YAAY,SAKjC;IACC,MAAM,MAAM;IACZ,MAAM,SAAS,MAAM,GAAG,CAAC;aACd,EAAE,UAAU,SAAS,CAAC,EAAE,EAAE,UAAU,SAAS,CAAC,EAAE,EAAE,UAAU,UAAU,CAAC,EAAE,EAAE,UAAU,OAAO,CAAC;gBAC1F,CAAC;IACf,OAAO,MAAM,CAAC,EAAE;AAClB;AAKO,eAAe;IACpB,MAAM,MAAM;IACZ,MAAM,SAAS,MAAM,GAAG,CAAC,2EAA2E,CAAC;IACrG,OAAO;AACT;AAKO,eAAe,iBAAiB,SAAiB;IACtD,MAAM,MAAM;IACZ,MAAM,SAAS,MAAM,GAAG,CAAC,wCAAwC,EAAE,UAAU,kCAAkC,CAAC;IAChH,OAAO;AACT;AAKO,eAAe,iBAAiB,OAAe,EAAE,cAAsB;IAC5E,MAAM,MAAM;IACZ,MAAM,SAAS,MAAM,GAAG,CAAC;mDACwB,EAAE,eAAe;gBACpD,EAAE,QAAQ;gBACV,CAAC;IACf,OAAO,MAAM,CAAC,EAAE;AAClB;AAKO,eAAe,WAAW,SAAiB;IAChD,MAAM,MAAM;IACZ,MAAM,SAAS,MAAM,GAAG,CAAC,0CAA0C,EAAE,UAAU,CAAC;IAChF,OAAO,MAAM,CAAC,EAAE,IAAI;AACtB;AAKO,eAAe;IACpB,MAAM,MAAM;IACZ,MAAM,SAAS,MAAM,GAAG,CAAC,sBAAsB,CAAC;IAChD,OAAO;AACT;AAKO,eAAe;IACpB,MAAM,MAAM;IACZ,MAAM,SAAS,MAAM,GAAG,CAAC;;;;EAIzB,CAAC;IACD,OAAO;AACT;AAKO,eAAe;IACpB,MAAM,MAAM;IACZ,MAAM,SAAS,MAAM,GAAG,CAAC;;;;;;;;;;;;;;;;;;;;;;;;EAwBzB,CAAC;IACD,OAAO;AACT","debugId":null}},
    {"offset": {"line": 190, "column": 0}, "map": {"version":3,"sources":["file:///Users/8teen/Downloads/Devlopment/GitHub%20Repository/medsecurree/lib/encryption.ts"],"sourcesContent":["import crypto from \"crypto\"\n\n// Generate a key from environment variable or create a default one\nconst getEncryptionKey = (): Buffer => {\n  const keyEnv = process.env.ENCRYPTION_KEY\n  if (!keyEnv) {\n    throw new Error(\"ENCRYPTION_KEY environment variable is not set\")\n  }\n  // Ensure the key is exactly 32 bytes (256 bits) for AES-256\n  const key = crypto.scryptSync(keyEnv, \"salt\", 32)\n  return key\n}\n\n/**\n * Encrypts vital data using AES-256-GCM\n * @param data - Plain text data to encrypt\n * @returns Encrypted data in format: iv:encryptedData:authTag (all base64)\n */\nexport function encryptVitalData(data: Record<string, any>): string {\n  try {\n    const key = getEncryptionKey()\n    const plaintext = JSON.stringify(data)\n\n    // Generate a random IV (Initialization Vector)\n    const iv = crypto.randomBytes(16)\n\n    // Create cipher\n    const cipher = crypto.createCipheriv(\"aes-256-gcm\", key, iv)\n\n    // Encrypt the data\n    let encryptedData = cipher.update(plaintext, \"utf8\", \"hex\")\n    encryptedData += cipher.final(\"hex\")\n\n    // Get authentication tag\n    const authTag = cipher.getAuthTag()\n\n    // Return combined format: iv:encryptedData:authTag (all in base64 for safe transmission)\n    const result = `${iv.toString(\"base64\")}:${encryptedData}:${authTag.toString(\"base64\")}`\n    return result\n  } catch (error) {\n    console.error(\"Encryption error:\", error)\n    throw new Error(\"Failed to encrypt vital data\")\n  }\n}\n\n/**\n * Decrypts vital data encrypted with encryptVitalData\n * @param encryptedString - Encrypted data in format: iv:encryptedData:authTag\n * @returns Decrypted data as parsed object\n */\nexport function decryptVitalData(encryptedString: string): Record<string, any> {\n  try {\n    const key = getEncryptionKey()\n    const parts = encryptedString.split(\":\")\n\n    if (parts.length !== 3) {\n      throw new Error(\"Invalid encrypted data format\")\n    }\n\n    const iv = Buffer.from(parts[0], \"base64\")\n    const encryptedData = parts[1]\n    const authTag = Buffer.from(parts[2], \"base64\")\n\n    // Create decipher\n    const decipher = crypto.createDecipheriv(\"aes-256-gcm\", key, iv)\n    decipher.setAuthTag(authTag)\n\n    // Decrypt the data\n    let decrypted = decipher.update(encryptedData, \"hex\", \"utf8\")\n    decrypted += decipher.final(\"utf8\")\n\n    return JSON.parse(decrypted)\n  } catch (error) {\n    console.error(\"Decryption error:\", error)\n    throw new Error(\"Failed to decrypt vital data\")\n  }\n}\n\n/**\n * Validates encrypted data integrity\n * @param encryptedString - Encrypted data to validate\n * @returns true if valid format, false otherwise\n */\nexport function isValidEncryptedFormat(encryptedString: string): boolean {\n  try {\n    const parts = encryptedString.split(\":\")\n    if (parts.length !== 3) return false\n\n    // Try to decode base64 parts\n    Buffer.from(parts[0], \"base64\")\n    Buffer.from(parts[2], \"base64\")\n\n    return true\n  } catch {\n    return false\n  }\n}\n"],"names":[],"mappings":";;;;;;;;AAAA;;AAEA,mEAAmE;AACnE,MAAM,mBAAmB;IACvB,MAAM,SAAS,QAAQ,GAAG,CAAC,cAAc;IACzC,IAAI,CAAC,QAAQ;QACX,MAAM,IAAI,MAAM;IAClB;IACA,4DAA4D;IAC5D,MAAM,MAAM,gHAAM,CAAC,UAAU,CAAC,QAAQ,QAAQ;IAC9C,OAAO;AACT;AAOO,SAAS,iBAAiB,IAAyB;IACxD,IAAI;QACF,MAAM,MAAM;QACZ,MAAM,YAAY,KAAK,SAAS,CAAC;QAEjC,+CAA+C;QAC/C,MAAM,KAAK,gHAAM,CAAC,WAAW,CAAC;QAE9B,gBAAgB;QAChB,MAAM,SAAS,gHAAM,CAAC,cAAc,CAAC,eAAe,KAAK;QAEzD,mBAAmB;QACnB,IAAI,gBAAgB,OAAO,MAAM,CAAC,WAAW,QAAQ;QACrD,iBAAiB,OAAO,KAAK,CAAC;QAE9B,yBAAyB;QACzB,MAAM,UAAU,OAAO,UAAU;QAEjC,yFAAyF;QACzF,MAAM,SAAS,GAAG,GAAG,QAAQ,CAAC,UAAU,CAAC,EAAE,cAAc,CAAC,EAAE,QAAQ,QAAQ,CAAC,WAAW;QACxF,OAAO;IACT,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,qBAAqB;QACnC,MAAM,IAAI,MAAM;IAClB;AACF;AAOO,SAAS,iBAAiB,eAAuB;IACtD,IAAI;QACF,MAAM,MAAM;QACZ,MAAM,QAAQ,gBAAgB,KAAK,CAAC;QAEpC,IAAI,MAAM,MAAM,KAAK,GAAG;YACtB,MAAM,IAAI,MAAM;QAClB;QAEA,MAAM,KAAK,OAAO,IAAI,CAAC,KAAK,CAAC,EAAE,EAAE;QACjC,MAAM,gBAAgB,KAAK,CAAC,EAAE;QAC9B,MAAM,UAAU,OAAO,IAAI,CAAC,KAAK,CAAC,EAAE,EAAE;QAEtC,kBAAkB;QAClB,MAAM,WAAW,gHAAM,CAAC,gBAAgB,CAAC,eAAe,KAAK;QAC7D,SAAS,UAAU,CAAC;QAEpB,mBAAmB;QACnB,IAAI,YAAY,SAAS,MAAM,CAAC,eAAe,OAAO;QACtD,aAAa,SAAS,KAAK,CAAC;QAE5B,OAAO,KAAK,KAAK,CAAC;IACpB,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,qBAAqB;QACnC,MAAM,IAAI,MAAM;IAClB;AACF;AAOO,SAAS,uBAAuB,eAAuB;IAC5D,IAAI;QACF,MAAM,QAAQ,gBAAgB,KAAK,CAAC;QACpC,IAAI,MAAM,MAAM,KAAK,GAAG,OAAO;QAE/B,6BAA6B;QAC7B,OAAO,IAAI,CAAC,KAAK,CAAC,EAAE,EAAE;QACtB,OAAO,IAAI,CAAC,KAAK,CAAC,EAAE,EAAE;QAEtB,OAAO;IACT,EAAE,OAAM;QACN,OAAO;IACT;AACF","debugId":null}},
    {"offset": {"line": 269, "column": 0}, "map": {"version":3,"sources":["file:///Users/8teen/Downloads/Devlopment/GitHub%20Repository/medsecurree/app/api/vitals/latest/route.ts"],"sourcesContent":["import { type NextRequest, NextResponse } from \"next/server\"\nimport { getLatestVitals } from \"@/lib/db\"\nimport { decryptVitalData, isValidEncryptedFormat } from \"@/lib/encryption\"\n\n/**\n * Retrieves the latest vital readings for a patient (decrypted)\n * GET /api/vitals/latest?patientId=PAT001\n */\nexport async function GET(request: NextRequest) {\n  try {\n    const patientId = request.nextUrl.searchParams.get(\"patientId\")\n\n    if (!patientId) {\n      return NextResponse.json({ error: \"Patient ID is required\" }, { status: 400 })\n    }\n\n    const vital = await getLatestVitals(patientId)\n\n    if (!vital) {\n      return NextResponse.json({ error: \"No vital data found for this patient\" }, { status: 404 })\n    }\n\n    // Decrypt if encrypted data exists\n    let decryptedData = null\n    if (vital.encrypted_data && isValidEncryptedFormat(vital.encrypted_data)) {\n      try {\n        decryptedData = decryptVitalData(vital.encrypted_data)\n      } catch (error) {\n        console.warn(\"Could not decrypt vital data:\", error)\n      }\n    }\n\n    return NextResponse.json({\n      success: true,\n      vital: {\n        id: vital.id,\n        patientId: vital.patient_id,\n        ambulanceId: vital.ambulance_id,\n        heartRate: vital.heart_rate,\n        spo2: vital.spo2,\n        systolicBp: vital.systolic_bp,\n        diastolicBp: vital.diastolic_bp,\n        temperature: vital.temperature,\n        status: vital.status,\n        recordedAt: vital.recorded_at,\n        decrypted: decryptedData,\n      },\n    })\n  } catch (error) {\n    console.error(\"Error retrieving vital data:\", error)\n    return NextResponse.json({ error: \"Failed to retrieve vital data\" }, { status: 500 })\n  }\n}\n"],"names":[],"mappings":";;;;AAAA;AACA;AACA;;;;AAMO,eAAe,IAAI,OAAoB;IAC5C,IAAI;QACF,MAAM,YAAY,QAAQ,OAAO,CAAC,YAAY,CAAC,GAAG,CAAC;QAEnD,IAAI,CAAC,WAAW;YACd,OAAO,gJAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;YAAyB,GAAG;gBAAE,QAAQ;YAAI;QAC9E;QAEA,MAAM,QAAQ,MAAM,IAAA,8HAAe,EAAC;QAEpC,IAAI,CAAC,OAAO;YACV,OAAO,gJAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;YAAuC,GAAG;gBAAE,QAAQ;YAAI;QAC5F;QAEA,mCAAmC;QACnC,IAAI,gBAAgB;QACpB,IAAI,MAAM,cAAc,IAAI,IAAA,6IAAsB,EAAC,MAAM,cAAc,GAAG;YACxE,IAAI;gBACF,gBAAgB,IAAA,uIAAgB,EAAC,MAAM,cAAc;YACvD,EAAE,OAAO,OAAO;gBACd,QAAQ,IAAI,CAAC,iCAAiC;YAChD;QACF;QAEA,OAAO,gJAAY,CAAC,IAAI,CAAC;YACvB,SAAS;YACT,OAAO;gBACL,IAAI,MAAM,EAAE;gBACZ,WAAW,MAAM,UAAU;gBAC3B,aAAa,MAAM,YAAY;gBAC/B,WAAW,MAAM,UAAU;gBAC3B,MAAM,MAAM,IAAI;gBAChB,YAAY,MAAM,WAAW;gBAC7B,aAAa,MAAM,YAAY;gBAC/B,aAAa,MAAM,WAAW;gBAC9B,QAAQ,MAAM,MAAM;gBACpB,YAAY,MAAM,WAAW;gBAC7B,WAAW;YACb;QACF;IACF,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,gCAAgC;QAC9C,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE,OAAO;QAAgC,GAAG;YAAE,QAAQ;QAAI;IACrF;AACF","debugId":null}}]
}