{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 52, "column": 0}, "map": {"version":3,"sources":["file:///Users/8teen/Downloads/Devlopment/GitHub%20Repository/medsecurree/lib/encryption.ts"],"sourcesContent":["import crypto from \"crypto\"\n\n// Generate a key from environment variable or create a default one\nconst getEncryptionKey = (): Buffer => {\n  const keyEnv = process.env.ENCRYPTION_KEY\n  if (!keyEnv) {\n    throw new Error(\"ENCRYPTION_KEY environment variable is not set\")\n  }\n  // Ensure the key is exactly 32 bytes (256 bits) for AES-256\n  const key = crypto.scryptSync(keyEnv, \"salt\", 32)\n  return key\n}\n\n/**\n * Encrypts vital data using AES-256-GCM\n * @param data - Plain text data to encrypt\n * @returns Encrypted data in format: iv:encryptedData:authTag (all base64)\n */\nexport function encryptVitalData(data: Record<string, any>): string {\n  try {\n    const key = getEncryptionKey()\n    const plaintext = JSON.stringify(data)\n\n    // Generate a random IV (Initialization Vector)\n    const iv = crypto.randomBytes(16)\n\n    // Create cipher\n    const cipher = crypto.createCipheriv(\"aes-256-gcm\", key, iv)\n\n    // Encrypt the data\n    let encryptedData = cipher.update(plaintext, \"utf8\", \"hex\")\n    encryptedData += cipher.final(\"hex\")\n\n    // Get authentication tag\n    const authTag = cipher.getAuthTag()\n\n    // Return combined format: iv:encryptedData:authTag (all in base64 for safe transmission)\n    const result = `${iv.toString(\"base64\")}:${encryptedData}:${authTag.toString(\"base64\")}`\n    return result\n  } catch (error) {\n    console.error(\"Encryption error:\", error)\n    throw new Error(\"Failed to encrypt vital data\")\n  }\n}\n\n/**\n * Decrypts vital data encrypted with encryptVitalData\n * @param encryptedString - Encrypted data in format: iv:encryptedData:authTag\n * @returns Decrypted data as parsed object\n */\nexport function decryptVitalData(encryptedString: string): Record<string, any> {\n  try {\n    const key = getEncryptionKey()\n    const parts = encryptedString.split(\":\")\n\n    if (parts.length !== 3) {\n      throw new Error(\"Invalid encrypted data format\")\n    }\n\n    const iv = Buffer.from(parts[0], \"base64\")\n    const encryptedData = parts[1]\n    const authTag = Buffer.from(parts[2], \"base64\")\n\n    // Create decipher\n    const decipher = crypto.createDecipheriv(\"aes-256-gcm\", key, iv)\n    decipher.setAuthTag(authTag)\n\n    // Decrypt the data\n    let decrypted = decipher.update(encryptedData, \"hex\", \"utf8\")\n    decrypted += decipher.final(\"utf8\")\n\n    return JSON.parse(decrypted)\n  } catch (error) {\n    console.error(\"Decryption error:\", error)\n    throw new Error(\"Failed to decrypt vital data\")\n  }\n}\n\n/**\n * Validates encrypted data integrity\n * @param encryptedString - Encrypted data to validate\n * @returns true if valid format, false otherwise\n */\nexport function isValidEncryptedFormat(encryptedString: string): boolean {\n  try {\n    const parts = encryptedString.split(\":\")\n    if (parts.length !== 3) return false\n\n    // Try to decode base64 parts\n    Buffer.from(parts[0], \"base64\")\n    Buffer.from(parts[2], \"base64\")\n\n    return true\n  } catch {\n    return false\n  }\n}\n"],"names":[],"mappings":";;;;;;;;AAAA;;AAEA,mEAAmE;AACnE,MAAM,mBAAmB;IACvB,MAAM,SAAS,QAAQ,GAAG,CAAC,cAAc;IACzC,IAAI,CAAC,QAAQ;QACX,MAAM,IAAI,MAAM;IAClB;IACA,4DAA4D;IAC5D,MAAM,MAAM,gHAAM,CAAC,UAAU,CAAC,QAAQ,QAAQ;IAC9C,OAAO;AACT;AAOO,SAAS,iBAAiB,IAAyB;IACxD,IAAI;QACF,MAAM,MAAM;QACZ,MAAM,YAAY,KAAK,SAAS,CAAC;QAEjC,+CAA+C;QAC/C,MAAM,KAAK,gHAAM,CAAC,WAAW,CAAC;QAE9B,gBAAgB;QAChB,MAAM,SAAS,gHAAM,CAAC,cAAc,CAAC,eAAe,KAAK;QAEzD,mBAAmB;QACnB,IAAI,gBAAgB,OAAO,MAAM,CAAC,WAAW,QAAQ;QACrD,iBAAiB,OAAO,KAAK,CAAC;QAE9B,yBAAyB;QACzB,MAAM,UAAU,OAAO,UAAU;QAEjC,yFAAyF;QACzF,MAAM,SAAS,GAAG,GAAG,QAAQ,CAAC,UAAU,CAAC,EAAE,cAAc,CAAC,EAAE,QAAQ,QAAQ,CAAC,WAAW;QACxF,OAAO;IACT,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,qBAAqB;QACnC,MAAM,IAAI,MAAM;IAClB;AACF;AAOO,SAAS,iBAAiB,eAAuB;IACtD,IAAI;QACF,MAAM,MAAM;QACZ,MAAM,QAAQ,gBAAgB,KAAK,CAAC;QAEpC,IAAI,MAAM,MAAM,KAAK,GAAG;YACtB,MAAM,IAAI,MAAM;QAClB;QAEA,MAAM,KAAK,OAAO,IAAI,CAAC,KAAK,CAAC,EAAE,EAAE;QACjC,MAAM,gBAAgB,KAAK,CAAC,EAAE;QAC9B,MAAM,UAAU,OAAO,IAAI,CAAC,KAAK,CAAC,EAAE,EAAE;QAEtC,kBAAkB;QAClB,MAAM,WAAW,gHAAM,CAAC,gBAAgB,CAAC,eAAe,KAAK;QAC7D,SAAS,UAAU,CAAC;QAEpB,mBAAmB;QACnB,IAAI,YAAY,SAAS,MAAM,CAAC,eAAe,OAAO;QACtD,aAAa,SAAS,KAAK,CAAC;QAE5B,OAAO,KAAK,KAAK,CAAC;IACpB,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,qBAAqB;QACnC,MAAM,IAAI,MAAM;IAClB;AACF;AAOO,SAAS,uBAAuB,eAAuB;IAC5D,IAAI;QACF,MAAM,QAAQ,gBAAgB,KAAK,CAAC;QACpC,IAAI,MAAM,MAAM,KAAK,GAAG,OAAO;QAE/B,6BAA6B;QAC7B,OAAO,IAAI,CAAC,KAAK,CAAC,EAAE,EAAE;QACtB,OAAO,IAAI,CAAC,KAAK,CAAC,EAAE,EAAE;QAEtB,OAAO;IACT,EAAE,OAAM;QACN,OAAO;IACT;AACF","debugId":null}},
    {"offset": {"line": 131, "column": 0}, "map": {"version":3,"sources":["file:///Users/8teen/Downloads/Devlopment/GitHub%20Repository/medsecurree/lib/db.ts"],"sourcesContent":["import { neon } from \"@neondatabase/serverless\"\n\n// Create a singleton instance of the SQL client\nlet sqlInstance: ReturnType<typeof neon> | null = null\nconst USE_MOCK_DATA = !process.env.NEON_POSTGRES_URL && !process.env.NEON_NEON_NEON_DATABASE_URL;\n\n/**\n * Gets or creates a Neon SQL client instance\n */\nexport function getSql() {\n  if (USE_MOCK_DATA) return null;\n\n  if (!sqlInstance) {\n    const databaseUrl = process.env.NEON_POSTGRES_URL || process.env.NEON_NEON_NEON_DATABASE_URL\n    if (!databaseUrl) {\n      console.warn(\"Database URL is not configured. Falling back to mock data.\")\n      return null;\n    }\n    sqlInstance = neon(databaseUrl)\n  }\n  return sqlInstance\n}\n\n// --- MOCK DATA GENERATORS ---\nconst MOCK_PATIENTS = [\n  { patient_id: \"PAT001\", name: \"John Doe\", age: 45, medical_condition: \"Cardiac Arrhythmia\" },\n  { patient_id: \"PAT002\", name: \"Jane Smith\", age: 62, medical_condition: \"Hypertension\" },\n  { patient_id: \"PAT003\", name: \"Robert Johnson\", age: 35, medical_condition: \"Allergic Reaction\" },\n  { patient_id: \"PAT004\", name: \"Emily Davis\", age: 28, medical_condition: \"Asthma Attack\" },\n];\n\nconst generateMockVital = (patientId: string) => ({\n  id: Math.floor(Math.random() * 10000),\n  patient_id: patientId,\n  ambulance_id: \"AMB-\" + Math.floor(Math.random() * 100),\n  heart_rate: 60 + Math.floor(Math.random() * 40),\n  spo2: 95 + Math.floor(Math.random() * 5),\n  systolic_bp: 110 + Math.floor(Math.random() * 30),\n  diastolic_bp: 70 + Math.floor(Math.random() * 20),\n  temperature: 36.5 + Math.random(),\n  status: \"Normal\",\n  recorded_at: new Date().toISOString(),\n  encrypted_data: \"mock-encrypted-string-\" + Math.random().toString(36).substring(7)\n});\n\nconst generateMockAlert = (patientId: string) => ({\n  id: Math.floor(Math.random() * 1000),\n  patient_id: patientId,\n  alert_type: \"Vital Sign Warning\",\n  alert_level: [\"Low\", \"Medium\", \"High\", \"Critical\"][Math.floor(Math.random() * 4)],\n  message: `Abnormal vitals detected for ${patientId}`,\n  is_acknowledged: false,\n  created_at: new Date().toISOString()\n});\n\n/**\n * Fetches current vital data for a patient\n */\nexport async function getLatestVitals(patientId: string) {\n  const sql = getSql()\n  if (!sql) {\n    return generateMockVital(patientId);\n  }\n  try {\n    const result: any = await sql`SELECT * FROM vitals WHERE patient_id = ${patientId} ORDER BY recorded_at DESC LIMIT 1`\n    return result[0] || null\n  } catch (e) {\n    console.error(\"DB Error:\", e);\n    return generateMockVital(patientId);\n  }\n}\n\n/**\n * Fetches all recent vitals for a patient\n */\nexport async function getRecentVitals(patientId: string, minutes = 60) {\n  const sql = getSql()\n  if (!sql) {\n    return Array.from({ length: 10 }, (_, i) => {\n      const v = generateMockVital(patientId);\n      v.recorded_at = new Date(Date.now() - i * 60000).toISOString();\n      return v;\n    });\n  }\n  try {\n    const result = await sql`SELECT * FROM vitals \n       WHERE patient_id = ${patientId} \n       AND recorded_at > NOW() - INTERVAL '${minutes} minutes'\n       ORDER BY recorded_at ASC`\n    return result\n  } catch (e) {\n    return Array.from({ length: 10 }, (_, i) => {\n      const v = generateMockVital(patientId);\n      v.recorded_at = new Date(Date.now() - i * 60000).toISOString();\n      return v;\n    });\n  }\n}\n\n/**\n * Stores vital data in the database\n */\nexport async function storeVitals(vitalData: {\n  patientId: string\n  ambulanceId: string\n  heartRate: number\n  spo2: number\n  systolicBp: number\n  diastolicBp: number\n  temperature: number\n  status: string\n  encryptedData?: string\n}) {\n  const sql = getSql()\n  if (!sql) {\n    console.log(\"[Mock DB] Storing vitals:\", vitalData);\n    return { ...vitalData, id: Math.floor(Math.random() * 10000), recorded_at: new Date().toISOString() };\n  }\n  try {\n    const result: any = await sql`INSERT INTO vitals \n       (patient_id, ambulance_id, heart_rate, spo2, systolic_bp, diastolic_bp, temperature, status, encrypted_data)\n       VALUES (${vitalData.patientId}, ${vitalData.ambulanceId}, ${vitalData.heartRate}, ${vitalData.spo2}, ${vitalData.systolicBp}, ${vitalData.diastolicBp}, ${vitalData.temperature}, ${vitalData.status}, ${vitalData.encryptedData || null})\n       RETURNING *`\n    return result[0]\n  } catch (e) {\n    console.log(\"[Mock DB Fallback] Storing vitals:\", vitalData);\n    return { ...vitalData, id: Math.floor(Math.random() * 10000), recorded_at: new Date().toISOString() };\n  }\n}\n\n/**\n * Creates an alert for critical conditions\n */\nexport async function createAlert(alertData: {\n  patientId: string\n  alertType: string\n  alertLevel: string\n  message: string\n}) {\n  const sql = getSql()\n  if (!sql) {\n    console.log(\"[Mock DB] Creating alert:\", alertData);\n    return { ...alertData, id: Math.floor(Math.random() * 1000), is_acknowledged: false, created_at: new Date().toISOString() };\n  }\n  try {\n    const result: any = await sql`INSERT INTO alerts (patient_id, alert_type, alert_level, message)\n       VALUES (${alertData.patientId}, ${alertData.alertType}, ${alertData.alertLevel}, ${alertData.message})\n       RETURNING *`\n    return result[0]\n  } catch (e) {\n    console.log(\"[Mock DB Fallback] Creating alert:\", alertData);\n    return { ...alertData, id: Math.floor(Math.random() * 1000), is_acknowledged: false, created_at: new Date().toISOString() };\n  }\n}\n\n/**\n * Fetches all active (unacknowledged) alerts\n */\nexport async function getActiveAlerts() {\n  const sql = getSql()\n  if (!sql) {\n    // Return some mock alerts occasionally\n    if (Math.random() > 0.7) {\n      return [generateMockAlert(MOCK_PATIENTS[0].patient_id)];\n    }\n    return [];\n  }\n  try {\n    const result = await sql`SELECT * FROM alerts WHERE is_acknowledged = FALSE ORDER BY created_at DESC`\n    return result\n  } catch (e) {\n    if (Math.random() > 0.7) {\n      return [generateMockAlert(MOCK_PATIENTS[0].patient_id)];\n    }\n    return [];\n  }\n}\n\n/**\n * Fetches all alerts for a specific patient\n */\nexport async function getPatientAlerts(patientId: string) {\n  const sql = getSql()\n  if (!sql) {\n    return [generateMockAlert(patientId)];\n  }\n  try {\n    const result = await sql`SELECT * FROM alerts WHERE patient_id = ${patientId} ORDER BY created_at DESC LIMIT 50`\n    return result\n  } catch (e) {\n    return [generateMockAlert(patientId)];\n  }\n}\n\n/**\n * Acknowledges an alert\n */\nexport async function acknowledgeAlert(alertId: number, acknowledgedBy: string) {\n  const sql = getSql()\n  if (!sql) {\n    return { id: alertId, is_acknowledged: true, acknowledged_by: acknowledgedBy, acknowledged_at: new Date().toISOString() };\n  }\n  try {\n    const result: any = await sql`UPDATE alerts \n       SET is_acknowledged = TRUE, acknowledged_by = ${acknowledgedBy}, acknowledged_at = NOW()\n       WHERE id = ${alertId}\n       RETURNING *`\n    return result[0]\n  } catch (e) {\n    return { id: alertId, is_acknowledged: true, acknowledged_by: acknowledgedBy, acknowledged_at: new Date().toISOString() };\n  }\n}\n\n/**\n * Fetches patient information\n */\nexport async function getPatient(patientId: string) {\n  const sql = getSql()\n  if (!sql) {\n    return MOCK_PATIENTS.find(p => p.patient_id === patientId) || MOCK_PATIENTS[0];\n  }\n  try {\n    const result: any = await sql`SELECT * FROM patients WHERE patient_id = ${patientId}`\n    return result[0] || null\n  } catch (e) {\n    return MOCK_PATIENTS.find(p => p.patient_id === patientId) || MOCK_PATIENTS[0];\n  }\n}\n\n/**\n * Gets all patients\n */\nexport async function getAllPatients() {\n  const sql = getSql()\n  if (!sql) return MOCK_PATIENTS;\n  try {\n    const result = await sql`SELECT * FROM patients`\n    return result\n  } catch (e) {\n    return MOCK_PATIENTS;\n  }\n}\n\n/**\n * Fetches all latest vitals for all patients grouped by patient\n */\nexport async function getAllLatestVitals() {\n  const sql = getSql()\n  if (!sql) {\n    return MOCK_PATIENTS.map(p => generateMockVital(p.patient_id));\n  }\n  try {\n    const result = await sql`\n      SELECT DISTINCT ON (patient_id) *\n      FROM vitals\n      ORDER BY patient_id, recorded_at DESC\n    `\n    return result\n  } catch (e) {\n    return MOCK_PATIENTS.map(p => generateMockVital(p.patient_id));\n  }\n}\n\n/**\n * Fetches all patients with their latest vitals\n */\nexport async function getAllPatientsWithVitals() {\n  const sql = getSql()\n  if (!sql) {\n    return MOCK_PATIENTS.map(p => {\n      const v = generateMockVital(p.patient_id);\n      return {\n        ...p,\n        vital_id: v.id,\n        heart_rate: v.heart_rate,\n        spo2: v.spo2,\n        systolic_bp: v.systolic_bp,\n        diastolic_bp: v.diastolic_bp,\n        temperature: v.temperature,\n        status: v.status,\n        recorded_at: v.recorded_at,\n        encrypted_data: v.encrypted_data,\n        ambulance_id: v.ambulance_id\n      };\n    });\n  }\n  try {\n    const result = await sql`\n      SELECT \n        p.patient_id,\n        p.name,\n        p.age,\n        p.medical_condition,\n        v.id as vital_id,\n        v.heart_rate,\n        v.spo2,\n        v.systolic_bp,\n        v.diastolic_bp,\n        v.temperature,\n        v.status,\n        v.recorded_at,\n        v.encrypted_data,\n        v.ambulance_id\n      FROM patients p\n      LEFT JOIN LATERAL (\n        SELECT * FROM vitals\n        WHERE patient_id = p.patient_id\n        ORDER BY recorded_at DESC\n        LIMIT 1\n      ) v ON true\n      ORDER BY p.patient_id\n    `\n    return result\n  } catch (e) {\n    return MOCK_PATIENTS.map(p => {\n      const v = generateMockVital(p.patient_id);\n      return {\n        ...p,\n        vital_id: v.id,\n        heart_rate: v.heart_rate,\n        spo2: v.spo2,\n        systolic_bp: v.systolic_bp,\n        diastolic_bp: v.diastolic_bp,\n        temperature: v.temperature,\n        status: v.status,\n        recorded_at: v.recorded_at,\n        encrypted_data: v.encrypted_data,\n        ambulance_id: v.ambulance_id\n      };\n    });\n  }\n}\n"],"names":[],"mappings":"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","debugId":null}},
    {"offset": {"line": 491, "column": 0}, "map": {"version":3,"sources":["file:///Users/8teen/Downloads/Devlopment/GitHub%20Repository/medsecurree/lib/classification.ts"],"sourcesContent":["/**\n * Classification thresholds for patient conditions\n */\nconst THRESHOLDS = {\n  CRITICAL: {\n    heartRate: { min: 40, max: 140 },\n    spo2: { min: 85 },\n    systolicBp: { min: 60, max: 200 },\n    diastolicBp: { min: 40, max: 120 },\n    temperature: { min: 32, max: 40 },\n  },\n  MODERATE: {\n    heartRate: { min: 50, max: 120 },\n    spo2: { min: 90 },\n    systolicBp: { min: 90, max: 180 },\n    diastolicBp: { min: 60, max: 110 },\n    temperature: { min: 36, max: 38.5 },\n  },\n  STABLE: {\n    heartRate: { min: 60, max: 100 },\n    spo2: { min: 95 },\n    systolicBp: { min: 100, max: 140 },\n    diastolicBp: { min: 70, max: 100 },\n    temperature: { min: 36.5, max: 37.5 },\n  },\n}\n\nexport interface VitalReadings {\n  heartRate: number\n  spo2: number\n  systolicBp: number\n  diastolicBp: number\n  temperature: number\n}\n\nexport interface ClassificationResult {\n  status: \"Critical\" | \"Moderate\" | \"Stable\"\n  riskFactors: string[]\n  score: number\n}\n\n/**\n * Classifies patient condition based on vital readings\n * Returns the most critical status from all vital parameters\n */\nexport function classifyPatientCondition(vitals: VitalReadings): ClassificationResult {\n  const riskFactors: string[] = []\n  let criticalCount = 0\n  let moderateCount = 0\n\n  // Check heart rate\n  if (vitals.heartRate < THRESHOLDS.CRITICAL.heartRate.min || vitals.heartRate > THRESHOLDS.CRITICAL.heartRate.max) {\n    riskFactors.push(`Heart rate ${vitals.heartRate} bpm (critical)`)\n    criticalCount++\n  } else if (\n    vitals.heartRate < THRESHOLDS.MODERATE.heartRate.min ||\n    vitals.heartRate > THRESHOLDS.MODERATE.heartRate.max\n  ) {\n    riskFactors.push(`Heart rate ${vitals.heartRate} bpm (moderate)`)\n    moderateCount++\n  }\n\n  // Check SpO2\n  if (vitals.spo2 < THRESHOLDS.CRITICAL.spo2.min) {\n    riskFactors.push(`SpO2 ${vitals.spo2}% (critical)`)\n    criticalCount++\n  } else if (vitals.spo2 < THRESHOLDS.MODERATE.spo2.min) {\n    riskFactors.push(`SpO2 ${vitals.spo2}% (moderate)`)\n    moderateCount++\n  }\n\n  // Check systolic BP\n  if (\n    vitals.systolicBp < THRESHOLDS.CRITICAL.systolicBp.min ||\n    vitals.systolicBp > THRESHOLDS.CRITICAL.systolicBp.max\n  ) {\n    riskFactors.push(`Systolic BP ${vitals.systolicBp} mmHg (critical)`)\n    criticalCount++\n  } else if (\n    vitals.systolicBp < THRESHOLDS.MODERATE.systolicBp.min ||\n    vitals.systolicBp > THRESHOLDS.MODERATE.systolicBp.max\n  ) {\n    riskFactors.push(`Systolic BP ${vitals.systolicBp} mmHg (moderate)`)\n    moderateCount++\n  }\n\n  // Check diastolic BP\n  if (\n    vitals.diastolicBp < THRESHOLDS.CRITICAL.diastolicBp.min ||\n    vitals.diastolicBp > THRESHOLDS.CRITICAL.diastolicBp.max\n  ) {\n    riskFactors.push(`Diastolic BP ${vitals.diastolicBp} mmHg (critical)`)\n    criticalCount++\n  } else if (\n    vitals.diastolicBp < THRESHOLDS.MODERATE.diastolicBp.min ||\n    vitals.diastolicBp > THRESHOLDS.MODERATE.diastolicBp.max\n  ) {\n    riskFactors.push(`Diastolic BP ${vitals.diastolicBp} mmHg (moderate)`)\n    moderateCount++\n  }\n\n  // Check temperature\n  if (\n    vitals.temperature < THRESHOLDS.CRITICAL.temperature.min ||\n    vitals.temperature > THRESHOLDS.CRITICAL.temperature.max\n  ) {\n    riskFactors.push(`Temperature ${vitals.temperature}째C (critical)`)\n    criticalCount++\n  } else if (\n    vitals.temperature < THRESHOLDS.MODERATE.temperature.min ||\n    vitals.temperature > THRESHOLDS.MODERATE.temperature.max\n  ) {\n    riskFactors.push(`Temperature ${vitals.temperature}째C (moderate)`)\n    moderateCount++\n  }\n\n  // Determine overall status\n  let status: \"Critical\" | \"Moderate\" | \"Stable\" = \"Stable\"\n  let score = 0\n\n  if (criticalCount >= 1) {\n    status = \"Critical\"\n    score = 90 + Math.min(criticalCount * 3, 10)\n  } else if (moderateCount >= 2) {\n    status = \"Critical\"\n    score = 80\n  } else if (moderateCount >= 1) {\n    status = \"Moderate\"\n    score = 60 + moderateCount * 10\n  } else {\n    status = \"Stable\"\n    score = 30\n  }\n\n  return {\n    status,\n    riskFactors,\n    score: Math.min(score, 100),\n  }\n}\n\n/**\n * Determines if an alert should be triggered\n */\nexport function shouldTriggerAlert(classification: ClassificationResult): boolean {\n  return classification.status === \"Critical\"\n}\n\n/**\n * Generates alert message based on risk factors\n */\nexport function generateAlertMessage(riskFactors: string[]): string {\n  if (riskFactors.length === 0) return \"\"\n  return `Critical condition detected: ${riskFactors.join(\", \")}`\n}\n"],"names":[],"mappings":"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","debugId":null}},
    {"offset": {"line": 643, "column": 0}, "map": {"version":3,"sources":["file:///Users/8teen/Downloads/Devlopment/GitHub%20Repository/medsecurree/lib/vital-validator.ts"],"sourcesContent":["/**\n * Validates vital readings against medical standards\n * Returns validation result with errors if any vital is out of range\n */\nexport interface ValidationResult {\n  isValid: boolean\n  errors: string[]\n}\n\nexport function validateVitals(vitals: {\n  heartRate: number\n  spo2: number\n  systolicBp: number\n  diastolicBp: number\n  temperature: number\n}): ValidationResult {\n  const errors: string[] = []\n\n  // Heart Rate: Normal range 40-180 bpm (includes athletes and critical patients)\n  if (vitals.heartRate < 40 || vitals.heartRate > 180) {\n    errors.push(`Heart rate ${vitals.heartRate} bpm is out of valid range (40-180)`)\n  }\n\n  // SpO2: Must be 60-100% (medical devices don't read below 60%)\n  if (vitals.spo2 < 60 || vitals.spo2 > 100) {\n    errors.push(`SpO2 ${vitals.spo2}% is out of valid range (60-100)`)\n  }\n\n  // Systolic BP: Normal range 40-250 mmHg\n  if (vitals.systolicBp < 40 || vitals.systolicBp > 250) {\n    errors.push(`Systolic BP ${vitals.systolicBp} mmHg is out of valid range (40-250)`)\n  }\n\n  // Diastolic BP: Normal range 20-150 mmHg\n  if (vitals.diastolicBp < 20 || vitals.diastolicBp > 150) {\n    errors.push(`Diastolic BP ${vitals.diastolicBp} mmHg is out of valid range (20-150)`)\n  }\n\n  // Systolic must always be >= Diastolic\n  if (vitals.systolicBp < vitals.diastolicBp) {\n    errors.push(`Systolic BP (${vitals.systolicBp}) cannot be less than Diastolic BP (${vitals.diastolicBp})`)\n  }\n\n  // Temperature: Valid range 32-42째C (includes hypothermia and hyperthermia)\n  if (vitals.temperature < 32 || vitals.temperature > 42) {\n    errors.push(`Temperature ${vitals.temperature}째C is out of valid range (32-42)`)\n  }\n\n  return {\n    isValid: errors.length === 0,\n    errors,\n  }\n}\n\n/**\n * Checks if a vital value is within emergency medical protocols\n */\nexport function isEmergencyVital(vitals: {\n  heartRate: number\n  spo2: number\n  systolicBp: number\n  diastolicBp: number\n  temperature: number\n}): boolean {\n  // Emergency conditions\n  if (vitals.heartRate < 50 || vitals.heartRate > 140) return true\n  if (vitals.spo2 < 85) return true\n  if (vitals.systolicBp < 90 || vitals.systolicBp > 180) return true\n  if (vitals.temperature > 39 || vitals.temperature < 35) return true\n\n  return false\n}\n"],"names":[],"mappings":"AAAA;;;CAGC;;;;;;AAMM,SAAS,eAAe,MAM9B;IACC,MAAM,SAAmB,EAAE;IAE3B,gFAAgF;IAChF,IAAI,OAAO,SAAS,GAAG,MAAM,OAAO,SAAS,GAAG,KAAK;QACnD,OAAO,IAAI,CAAC,CAAC,WAAW,EAAE,OAAO,SAAS,CAAC,mCAAmC,CAAC;IACjF;IAEA,+DAA+D;IAC/D,IAAI,OAAO,IAAI,GAAG,MAAM,OAAO,IAAI,GAAG,KAAK;QACzC,OAAO,IAAI,CAAC,CAAC,KAAK,EAAE,OAAO,IAAI,CAAC,gCAAgC,CAAC;IACnE;IAEA,wCAAwC;IACxC,IAAI,OAAO,UAAU,GAAG,MAAM,OAAO,UAAU,GAAG,KAAK;QACrD,OAAO,IAAI,CAAC,CAAC,YAAY,EAAE,OAAO,UAAU,CAAC,oCAAoC,CAAC;IACpF;IAEA,yCAAyC;IACzC,IAAI,OAAO,WAAW,GAAG,MAAM,OAAO,WAAW,GAAG,KAAK;QACvD,OAAO,IAAI,CAAC,CAAC,aAAa,EAAE,OAAO,WAAW,CAAC,oCAAoC,CAAC;IACtF;IAEA,uCAAuC;IACvC,IAAI,OAAO,UAAU,GAAG,OAAO,WAAW,EAAE;QAC1C,OAAO,IAAI,CAAC,CAAC,aAAa,EAAE,OAAO,UAAU,CAAC,oCAAoC,EAAE,OAAO,WAAW,CAAC,CAAC,CAAC;IAC3G;IAEA,2EAA2E;IAC3E,IAAI,OAAO,WAAW,GAAG,MAAM,OAAO,WAAW,GAAG,IAAI;QACtD,OAAO,IAAI,CAAC,CAAC,YAAY,EAAE,OAAO,WAAW,CAAC,gCAAgC,CAAC;IACjF;IAEA,OAAO;QACL,SAAS,OAAO,MAAM,KAAK;QAC3B;IACF;AACF;AAKO,SAAS,iBAAiB,MAMhC;IACC,uBAAuB;IACvB,IAAI,OAAO,SAAS,GAAG,MAAM,OAAO,SAAS,GAAG,KAAK,OAAO;IAC5D,IAAI,OAAO,IAAI,GAAG,IAAI,OAAO;IAC7B,IAAI,OAAO,UAAU,GAAG,MAAM,OAAO,UAAU,GAAG,KAAK,OAAO;IAC9D,IAAI,OAAO,WAAW,GAAG,MAAM,OAAO,WAAW,GAAG,IAAI,OAAO;IAE/D,OAAO;AACT","debugId":null}},
    {"offset": {"line": 695, "column": 0}, "map": {"version":3,"sources":["file:///Users/8teen/Downloads/Devlopment/GitHub%20Repository/medsecurree/app/api/vitals/transmit/route.ts"],"sourcesContent":["import { type NextRequest, NextResponse } from \"next/server\"\nimport { encryptVitalData } from \"@/lib/encryption\"\nimport { storeVitals, createAlert, getPatient } from \"@/lib/db\"\nimport { classifyPatientCondition, shouldTriggerAlert, generateAlertMessage } from \"@/lib/classification\"\nimport { validateVitals } from \"@/lib/vital-validator\"\n\n/**\n * Receives encrypted vital data from ambulance\n * POST /api/vitals/transmit\n */\nexport async function POST(request: NextRequest) {\n  try {\n    const body = await request.json()\n\n    const { patientId, ambulanceId, heartRate, spo2, systolicBp, diastolicBp, temperature } = body\n\n    // Validate required fields exist\n    if (!patientId || !ambulanceId) {\n      return NextResponse.json({ error: \"Missing required fields: patientId and ambulanceId\" }, { status: 400 })\n    }\n\n    if (\n      heartRate === undefined ||\n      spo2 === undefined ||\n      systolicBp === undefined ||\n      diastolicBp === undefined ||\n      temperature === undefined\n    ) {\n      return NextResponse.json({ error: \"Missing required vital fields\" }, { status: 400 })\n    }\n\n    // Validate vital values are legitimate medical readings\n    const validation = validateVitals({\n      heartRate,\n      spo2,\n      systolicBp,\n      diastolicBp,\n      temperature,\n    })\n\n    if (!validation.isValid) {\n      return NextResponse.json({ error: \"Invalid vital readings\", details: validation.errors }, { status: 400 })\n    }\n\n    // Classify patient condition based on vitals\n    const classification = classifyPatientCondition({\n      heartRate,\n      spo2,\n      systolicBp,\n      diastolicBp,\n      temperature,\n    })\n\n    // Encrypt the vital data - CRITICAL STEP\n    const vitalDataToEncrypt = {\n      patientId,\n      ambulanceId,\n      heartRate,\n      spo2,\n      systolicBp,\n      diastolicBp,\n      temperature,\n      timestamp: new Date().toISOString(),\n    }\n\n    const encryptedData = encryptVitalData(vitalDataToEncrypt)\n\n    // Store vitals in database with encrypted data\n    const storedVital = await storeVitals({\n      patientId,\n      ambulanceId,\n      heartRate,\n      spo2,\n      systolicBp,\n      diastolicBp,\n      temperature,\n      status: classification.status,\n      encryptedData, // Always store encrypted data\n    })\n\n    // If critical, create an alert\n    if (shouldTriggerAlert(classification)) {\n      const alertMessage = generateAlertMessage(classification.riskFactors)\n      await createAlert({\n        patientId,\n        alertType: \"CRITICAL_VITALS\",\n        alertLevel: \"CRITICAL\",\n        message: alertMessage,\n      })\n    }\n\n    // Get patient info for response\n    const patient = await getPatient(patientId)\n\n    return NextResponse.json(\n      {\n        success: true,\n        message: \"Vitals transmitted and encrypted successfully\",\n        vitalId: storedVital.id,\n        classification,\n        encrypted: true,\n        patient: patient ? { name: patient.name, age: patient.age } : null,\n      },\n      { status: 201 },\n    )\n  } catch (error) {\n    console.error(\"Error processing vital transmission:\", error)\n    return NextResponse.json(\n      {\n        error: \"Failed to process vital data transmission\",\n        details: error instanceof Error ? error.message : \"Unknown error\",\n      },\n      { status: 500 },\n    )\n  }\n}\n"],"names":[],"mappings":";;;;AAAA;AACA;AACA;AACA;AACA;;;;;;AAMO,eAAe,KAAK,OAAoB;IAC7C,IAAI;QACF,MAAM,OAAO,MAAM,QAAQ,IAAI;QAE/B,MAAM,EAAE,SAAS,EAAE,WAAW,EAAE,SAAS,EAAE,IAAI,EAAE,UAAU,EAAE,WAAW,EAAE,WAAW,EAAE,GAAG;QAE1F,iCAAiC;QACjC,IAAI,CAAC,aAAa,CAAC,aAAa;YAC9B,OAAO,gJAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;YAAqD,GAAG;gBAAE,QAAQ;YAAI;QAC1G;QAEA,IACE,cAAc,aACd,SAAS,aACT,eAAe,aACf,gBAAgB,aAChB,gBAAgB,WAChB;YACA,OAAO,gJAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;YAAgC,GAAG;gBAAE,QAAQ;YAAI;QACrF;QAEA,wDAAwD;QACxD,MAAM,aAAa,IAAA,6IAAc,EAAC;YAChC;YACA;YACA;YACA;YACA;QACF;QAEA,IAAI,CAAC,WAAW,OAAO,EAAE;YACvB,OAAO,gJAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;gBAA0B,SAAS,WAAW,MAAM;YAAC,GAAG;gBAAE,QAAQ;YAAI;QAC1G;QAEA,6CAA6C;QAC7C,MAAM,iBAAiB,IAAA,mJAAwB,EAAC;YAC9C;YACA;YACA;YACA;YACA;QACF;QAEA,yCAAyC;QACzC,MAAM,qBAAqB;YACzB;YACA;YACA;YACA;YACA;YACA;YACA;YACA,WAAW,IAAI,OAAO,WAAW;QACnC;QAEA,MAAM,gBAAgB,IAAA,uIAAgB,EAAC;QAEvC,+CAA+C;QAC/C,MAAM,cAAc,MAAM,IAAA,0HAAW,EAAC;YACpC;YACA;YACA;YACA;YACA;YACA;YACA;YACA,QAAQ,eAAe,MAAM;YAC7B;QACF;QAEA,+BAA+B;QAC/B,IAAI,IAAA,6IAAkB,EAAC,iBAAiB;YACtC,MAAM,eAAe,IAAA,+IAAoB,EAAC,eAAe,WAAW;YACpE,MAAM,IAAA,0HAAW,EAAC;gBAChB;gBACA,WAAW;gBACX,YAAY;gBACZ,SAAS;YACX;QACF;QAEA,gCAAgC;QAChC,MAAM,UAAU,MAAM,IAAA,yHAAU,EAAC;QAEjC,OAAO,gJAAY,CAAC,IAAI,CACtB;YACE,SAAS;YACT,SAAS;YACT,SAAS,YAAY,EAAE;YACvB;YACA,WAAW;YACX,SAAS,UAAU;gBAAE,MAAM,QAAQ,IAAI;gBAAE,KAAK,QAAQ,GAAG;YAAC,IAAI;QAChE,GACA;YAAE,QAAQ;QAAI;IAElB,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,wCAAwC;QACtD,OAAO,gJAAY,CAAC,IAAI,CACtB;YACE,OAAO;YACP,SAAS,iBAAiB,QAAQ,MAAM,OAAO,GAAG;QACpD,GACA;YAAE,QAAQ;QAAI;IAElB;AACF","debugId":null}}]
}